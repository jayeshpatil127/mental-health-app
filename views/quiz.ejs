<div id="chat-widget"></div>

<script>
  fetch("/chat-widget.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("chat-widget").innerHTML = html;

      // üî• NOW elements exist ‚Äî attach JS
      const toggleBtn = document.getElementById("chat-toggle");
      const chatBox = document.getElementById("chat-box");
      const form = document.getElementById("chat-form");
      const input = document.getElementById("message-input");
      const messages = document.getElementById("messages");

      // Toggle rocket
      toggleBtn.addEventListener("click", () => {
        chatBox.style.display =
          chatBox.style.display === "flex" ? "none" : "flex";
      });

      // Send message
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const text = input.value.trim();
        if (!text) return;

        messages.innerHTML += `
          <div class="msg-user mb-2">
            <span>${text}</span>
          </div>
        `;
        input.value = "";
        messages.scrollTop = messages.scrollHeight;

        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text }),
        });

        const data = await res.json();

        messages.innerHTML += `
          <div class="msg-bot mb-2">
            <span>${data.reply}</span>
          </div>
        `;
        messages.scrollTop = messages.scrollHeight;
      });
    });
</script>


<div class="container my-5" style="max-width:720px;">

  <!-- HEADER -->
  <div class="mb-4">
    <h4 class="fw-semibold mb-1">Mental Health Self-Assessment</h4>
    <p class="text-muted small mb-3">
      This self-check helps you understand symptoms. It is not a diagnosis.
    </p>

    <!-- QUIZ TYPE -->
    <div class="btn-group btn-group-sm">
      <button class="btn btn-outline-primary quiz-btn active" data-quiz="phq5">PHQ-5</button>
      <button class="btn btn-outline-primary quiz-btn" data-quiz="phq9">PHQ-9</button>
      <button class="btn btn-outline-primary quiz-btn" data-quiz="gad7">GAD-7</button>
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="mb-3">
    <div class="d-flex justify-content-between small text-muted">
      <span id="qCount">Question</span>
      <span id="percent">Progress</span>
    </div>
    <div class="progress" style="height:6px;">
      <div id="progress" class="progress-bar bg-dark"></div>
    </div>
  </div>

  <!-- CARD -->
  <div class="card shadow-sm">
    <div class="card-body p-4" id="quiz-box"></div>

    <div class="card-footer bg-white d-flex justify-content-end">
      <button id="next-btn" class="btn btn-dark px-4" disabled>
        Next
      </button>
    </div>
  </div>

  <!-- PRIVACY -->
  <div class="alert alert-warning small mt-4">
    üîí Your responses remain private and are used only to guide support.
  </div>

</div>

<style>
.option {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 12px 14px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: 0.15s;
  background: #fff;
}
.option:hover {
  background: #f8f9fa;
}
.option.selected {
  background: #212529;
  color: #fff;
  border-color: #212529;
}
.quiz-btn.active {
  background: #0d6efd;
  color: #fff;
}
</style>


<script>
const quizzes = {
  phq5: [
    "Little interest or pleasure in doing things?",
    "Feeling down or hopeless?",
    "Trouble with sleep?",
    "Feeling tired or low energy?",
    "Poor appetite or overeating?"
  ],
  phq9: [
    "Little interest or pleasure in doing things?",
    "Feeling down or hopeless?",
    "Trouble with sleep?",
    "Feeling tired or low energy?",
    "Poor appetite or overeating?",
    "Feeling bad about yourself?",
    "Trouble concentrating?",
    "Moving or speaking slowly or restlessness?",
    "Thoughts of self-harm?"
  ],
  gad7: [
    "Feeling nervous or anxious?",
    "Unable to control worrying?",
    "Worrying too much?",
    "Trouble relaxing?",
    "Restlessness?",
    "Easily annoyed?",
    "Feeling afraid something bad may happen?"
  ]
};

const options = [
  "Not at all",
  "Several days",
  "More than half the days",
  "Nearly every day"
];

let currentQuiz = "phq5";
let currentQ = 0;
let answers = [];

const quizBox = document.getElementById("quiz-box");
const nextBtn = document.getElementById("next-btn");
const progress = document.getElementById("progress");

document.querySelectorAll(".quiz-btn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".quiz-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentQuiz = btn.dataset.quiz;
    currentQ = 0;
    answers = [];
    nextBtn.style.display = "inline-block";
    loadQuestion();
  };
});

function loadQuestion() {
  quizBox.innerHTML = `
    <div class="question">${currentQ + 1}. ${quizzes[currentQuiz][currentQ]}</div>
    ${options.map((o,i)=>`<div class="option" data-val="${i}">${o}</div>`).join("")}
  `;

  document.querySelectorAll(".option").forEach(opt => {
    opt.onclick = () => {
      document.querySelectorAll(".option").forEach(o => o.classList.remove("selected"));
      opt.classList.add("selected");
      nextBtn.disabled = false;
    };
  });

  nextBtn.disabled = true;
  progress.style.width = `${(currentQ / quizzes[currentQuiz].length) * 100}%`;
}

nextBtn.onclick = () => {
  const selected = document.querySelector(".option.selected");
  if (!selected) return;
  answers.push(Number(selected.dataset.val));
  currentQ++;

  if (currentQ < quizzes[currentQuiz].length) {
    loadQuestion();
  } else {
    showResult();
  }
};

function showResult() {
  const score = answers.reduce((a,b)=>a+b,0);
  let result = "";
  let severity = "";

  if (currentQuiz === "phq5" || currentQuiz === "phq9") {
    if (score <= 4) severity = "Low";
    else if (score <= 9) severity = "Mild";
    else if (score <= 14) severity = "Moderate";
    else severity = "High";

    result = `${severity} level of depressive symptoms`;

  } else if (currentQuiz === "gad7") {
    if (score <= 4) severity = "Low";
    else if (score <= 9) severity = "Mild";
    else if (score <= 14) severity = "Moderate";
    else severity = "High";

    result = `${severity} level of anxiety symptoms`;
  }

  quizBox.innerHTML = `
    <h3>üìä Self Check Result</h3>
    <p><b>${result}</b></p>
    <p class="small text-muted">
      This self-check is not a medical diagnosis.
    </p>

    ${severity === "High" ? `
      <div style="color:red;font-weight:bold;">
        ‚ö†Ô∏è If you feel overwhelmed, please consider crisis support.
        <br>
        <a href="tel:18005990019">India: 1800-599-0019 (KIRAN)</a>
      </div>
    ` : `
      <p>üëâ Suggested next step: Complete today‚Äôs Mood tracking</p>
    `}
  `;

  nextBtn.style.display = "none";
  progress.style.width = "100%";
}

loadQuestion();
</script>
