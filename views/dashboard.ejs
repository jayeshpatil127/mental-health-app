<div id="chat-widget"></div>

<script>
  fetch("/chat-widget.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("chat-widget").innerHTML = html;

      // ðŸ”¥ NOW elements exist â€” attach JS
      const toggleBtn = document.getElementById("chat-toggle");
      const chatBox = document.getElementById("chat-box");
      const form = document.getElementById("chat-form");
      const input = document.getElementById("message-input");
      const messages = document.getElementById("messages");

      // Toggle rocket
      toggleBtn.addEventListener("click", () => {
        chatBox.style.display =
          chatBox.style.display === "flex" ? "none" : "flex";
      });

      // Send message
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const text = input.value.trim();
        if (!text) return;

        messages.innerHTML += `
          <div class="msg-user mb-2">
            <span>${text}</span>
          </div>
        `;
        input.value = "";
        messages.scrollTop = messages.scrollHeight;

        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text }),
        });

        const data = await res.json();

        messages.innerHTML += `
          <div class="msg-bot mb-2">
            <span>${data.reply}</span>
          </div>
        `;
        messages.scrollTop = messages.scrollHeight;
      });
    });
</script>

<div class="container-fluid mt-3">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h5 class="fw-semibold mb-0">
        Welcome back, <%= user.name %>
      </h5>
      <small class="text-muted">
        Your mental wellness snapshot
      </small>
    </div>

    <a href="/checkin" class="btn btn-sm btn-primary">
      + Log Mood
    </a>
  </div>

  <!-- STATS -->
 <div class="row g-2 mb-3">

  <!-- Today Mood -->
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm h-100">
      <div class="card-body py-3">
        <small class="text-muted">ðŸ˜Š Todayâ€™s Mood</small>
        <div class="fs-6 fw-semibold mt-1">
          <%= todayMood ? todayMood + "/10" : "Not logged" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Weekly Average -->
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm h-100">
      <div class="card-body py-3">
        <small class="text-muted">ðŸ“Š Weekly Avg</small>
        <div class="fs-6 fw-semibold mt-1">
          <%= avgMood ? avgMood + "/10" : "--" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Streak -->
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm h-100">
      <div class="card-body py-3">
        <small class="text-muted">ðŸ”¥ Streak</small>
        <div class="fs-6 fw-semibold mt-1">
          <%= streak %> days
        </div>
      </div>
    </div>
  </div>

</div>

        </div>
      </div>
    </div>

  </div>

  <!-- CHART -->
  <div class="card shadow-sm">
    <div class="card-body py-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-semibold mb-0">Weekly Mood Trend</h6>
        <small class="text-muted">Last 7 days</small>
      </div>
      <canvas id="moodChart" height="90"></canvas>
    </div>
  </div>

</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const labels = JSON.parse('<%- JSON.stringify(chartData.map(c => new Date(c.date).toLocaleDateString("en-US", { weekday: "short" }))) %>');

const data = JSON.parse('<%- JSON.stringify(chartData.map(c => c.mood)) %>');

new Chart(document.getElementById("moodChart"), {
  type: "line",
  data: {
    labels,
    datasets: [{
      data,
      borderColor: "#6366f1",
      backgroundColor: "rgba(99,102,241,0.15)",
      fill: true,
      tension: 0.4
    }]
  },
  options: {
    plugins: { legend: { display: false }},
    scales: { y: { min: 0, max: 10 }}
  }
});
</script>
